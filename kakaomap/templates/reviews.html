<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¦¬ë·° ë³´ê¸°</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            padding: 20px;
        }
        .store-info {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }
        .store-info img {
            width: 100px;
            height: 100px;
            margin-right: 20px;
        }
        .store-info h1 {
            margin: 0;
            font-size: 24px;
        }
        .store-info p {
            margin: 5px 0 0;
            font-size: 14px;
            color: #666;
        }

        .store-details {
            margin-top: 10px;
        }
        .rating {
            margin-top: 10px;
            font-size: 14px;
            display: flex;
            gap: 20px; /* ë³„ì  ê°„ ê°„ê²© */
        }
        .rating span {
            padding: 5px 10px;
            border-radius: 4px;
            display: inline-block;
            white-space: nowrap; /* í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆ ë°©ì§€ */
        }
        .rating .naver {
            background-color: #e6f4e6;
            color: #333;
        }
        .rating .kakao {
            background-color: #fff7cc;
            color: #333;
        }
        .rating .google {
            background-color: #d2e3fc;
            color: #333;
        }
        .rating .rating-label {
            margin-right: 8px; /* ë„¤ì´ë²„ì™€ ":" ì‚¬ì´ì˜ ê³µë°± */
        }
        .store-info img {
            max-width: 100%;
            height: auto;
            object-fit: cover;
        }
        .store-details p {
            margin: 0;
            padding: 5px 0;
            display: flex;
            align-items: center;
        }
        .details-label {
            display: inline-block;
            min-width: 80px; /* ë ˆì´ë¸” ì¹¸ì˜ ê³ ì •í­ */
            font-weight: bold;
            margin-right: 5px; /* ë ˆì´ë¸”ê³¼ ê°’ ì‚¬ì´ì˜ ê°„ê²© */
        }
        
        .details-value {
            margin-left: 0px; /* ë ˆì´ë¸”ê³¼ ê°’ ì‚¬ì´ì˜ ê°„ê²© */
        }
        .tab-menu {
            display: flex;
            border-bottom: 2px solid #ccc;
            margin-bottom: 20px;
        }
        .tab-menu button {
            flex: 1;
            padding: 10px;
            font-size: 14px;
            background: #f5f5f5;
            border: none;
            cursor: pointer;
        }
        .tab-menu button.active {
            background: #dcd6f7;
            font-weight: bold;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .filter-section {
            margin-bottom: 20px;
            display: flex;
            justify-content: flex-end;
            align-items: center;
        }
        .search-section {
            margin-bottom: 20px;
        }
        .review-section {
            margin-top: 20px;
        }
        .review {
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }
        .review:last-child {
            border-bottom: none;
        }
        .review-date {
            font-size: 12px;
            color: gray;
        }
        .review-text {
            margin-top: 5px;
            font-size: 14px;
        }
        .platform {
            font-weight: bold;
            color: #333;
            padding: 2px 4px;
            border-radius: 4px;
            display: inline-block;
        }
        .platform.naver {
            background-color: #e6f4e6;
        }
        .platform.kakao {
            background-color: #fff7cc;
        }
        .platform.google {
            background-color: #d2e3fc;
        }
    </style>
</head>
<body>
    <div class="store-info">
        <div class="store-details-container">
            <h1 id="store-name">ê°€ê²Œ ì´ë¦„</h1>
            <p id="store-address">ê°€ê²Œ ì£¼ì†Œ</p>
            <div class="store-details">
                <p id="store-phone"><span class="details-label">ì „í™”ë²ˆí˜¸ :</span><span id="phone-value">-</span></p>
                <p id="store-hours"><span class="details-label">ì˜ì—…ì‹œê°„ :</span><span id="hours-value">-</span></p>
                <p id="store-price"><span class="details-label">ê°€ê²©ëŒ€ :</span><span id="price-value">-</span></p>
            </div>
            <div class="rating">
                <span class="naver">ğŸŸ¢&nbsp; : <span id="naver-rating">-</span></span>
                <span class="kakao">ğŸŸ¡&nbsp; : <span id="kakao-rating">-</span></span>
                <span class="google">âšª&nbsp; : <span id="google-rating">-</span></span>
            </div>
        </div>
        <img id="store-image" src="https://via.placeholder.com/150" alt="ê°€ê²Œ ì´ë¯¸ì§€" style="width: 300px; height: 200px; object-fit: cover; border-radius: 8px;">

    </div>
    

    <div class="tab-menu">
        <button id="all-reviews-tab" class="active">3ì‚¬ ì „ì²´ ë¦¬ë·°</button>
        <button id="analysis-report-tab">ë¦¬ë·° ë¶„ì„ ë¦¬í¬íŠ¸</button>
    </div>

    <div id="all-reviews-content" class="tab-content active">
        <div class="filter-section">
            <label><input type="checkbox" id="naver-checkbox" checked> ë„¤ì´ë²„</label>
            <label><input type="checkbox" id="kakao-checkbox" checked> ì¹´ì¹´ì˜¤</label>
            <label><input type="checkbox" id="google-checkbox" checked> êµ¬ê¸€</label>
        </div>

        <div class="search-section">
            <input type="text" id="review-search" placeholder="ë¦¬ë·° ê²€ìƒ‰..." style="width: 100%; padding: 8px; font-size: 14px;">
        </div>

        <div id="reviews-container" class="review-section"></div>
    </div>

    <div id="analysis-report-content" class="tab-content">
        <p>ë¦¬ë·° ë¶„ì„ ë¦¬í¬íŠ¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const urlParams = new URLSearchParams(window.location.search);
            const store_id = urlParams.get('storeId');

            if (!store_id) {
                document.getElementById('reviews-container').innerHTML = "<p>ìœ íš¨í•œ Store IDê°€ í•„ìš”í•©ë‹ˆë‹¤.</p>";
                return;
            }

            function getFirebaseImageUrl(bucketName, path) {
                const encodedPath = encodeURIComponent(path);
                return `https://firebasestorage.googleapis.com/v0/b/${bucketName}/o/${encodedPath}?alt=media`;
            }

            function renderReviews(reviews) {
                const container = document.getElementById('reviews-container');
                if (reviews.length === 0) {
                    container.innerHTML = "<p>ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
                    return;
                }

                const reviewsHtml = reviews.map(review => {
                    const platformClass = review.platform === 'ë„¤ì´ë²„' ? 'naver' : review.platform === 'ì¹´ì¹´ì˜¤' ? 'kakao' : 'google';
                    return `<div class="review">
                                <div class="review-date">
                                    <span class="platform ${platformClass}">[${review.platform}]</span> ${review.review_date}
                                </div>
                                <div class="review-text">${review.review_text}</div>
                            </div>`;
                }).join('');

                container.innerHTML = reviewsHtml;
            }

            function filterReviews(reviews) {
                const naverChecked = document.getElementById('naver-checkbox').checked;
                const kakaoChecked = document.getElementById('kakao-checkbox').checked;
                const googleChecked = document.getElementById('google-checkbox').checked;
                const searchKeyword = document.getElementById('review-search').value.toLowerCase();

                const filteredReviews = reviews.filter(review => {
                    if (review.platform === 'ë„¤ì´ë²„' && !naverChecked) return false;
                    if (review.platform === 'ì¹´ì¹´ì˜¤' && !kakaoChecked) return false;
                    if (review.platform === 'êµ¬ê¸€' && !googleChecked) return false;
                    if (searchKeyword && !review.review_text.toLowerCase().includes(searchKeyword)) return false;
                    return true;
                });

                renderReviews(filteredReviews);
            }

            fetch(`http://127.0.0.1:5000/reviews/${store_id}`)
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        document.getElementById('reviews-container').innerHTML = `<p>${data.message}</p>`;
                        return;
                    }

                    // ê°€ê²Œ ì •ë³´ ì¶œë ¥
                    document.getElementById('store-name').textContent = data.store_name;
                    document.getElementById('store-address').textContent = data.address;
                    document.getElementById('phone-value').textContent = data.phone_number || '-';
                    document.getElementById('hours-value').textContent = data.business_hours || '-';
                    document.getElementById('price-value').textContent = data.price_range || '-';
                    document.getElementById('naver-rating').textContent = data.reviews[0]?.naver_rating ?? '-';
                    document.getElementById('kakao-rating').textContent = data.reviews[0]?.kakao_rating ?? '-';
                    document.getElementById('google-rating').textContent = data.reviews[0]?.google_rating ?? '-';
                    document.getElementById('store-image').src = data.menu_photo || "https://via.placeholder.com/150";

                    const reviews = data.reviews;
                    renderReviews(reviews);

                    // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë“±ë¡
                    document.getElementById('naver-checkbox').addEventListener('change', () => filterReviews(reviews));
                    document.getElementById('kakao-checkbox').addEventListener('change', () => filterReviews(reviews));
                    document.getElementById('google-checkbox').addEventListener('change', () => filterReviews(reviews));
                    document.getElementById('review-search').addEventListener('input', () => filterReviews(reviews));

                    // ë¶„ì„ ë¦¬í¬íŠ¸ ë Œë”ë§
                    const analysisReportContent = document.getElementById('analysis-report-content');
                    const imagePaths = [
                        `5_RadarChart/${store_id}_radar_chart.png`,
                        `1_WordCloud/${store_id}_wordcloud.png`,
                        `3_Distribution/weighted_rating_vs_price.png`,
                        `2_NegativeReview_Ratio/${store_id}_ë¦¬ë·°_ë¹„ìœ¨.png`,
                        `4_Keyword/${store_id}_keyword.png`,
                    ];

                    const reportContainer = document.createElement('div');
                    reportContainer.style.display = 'flex'; // Flexbox ì‚¬ìš©
                    reportContainer.style.flexDirection = 'column'; // ì„¸ë¡œ ì •ë ¬
                    reportContainer.style.alignItems = 'center'; // ê°€ë¡œ ê°€ìš´ë° ì •ë ¬
                    reportContainer.style.justifyContent = 'center'; // ì„¸ë¡œ ê°€ìš´ë° ì •ë ¬

                    // ì†Œì œëª© ì¶”ê°€
                    const negativeReviewTitle = document.createElement('h3');
                    negativeReviewTitle.textContent = "ë¦¬ë·° ë¶„ì„ ë¦¬í¬íŠ¸";
                    negativeReviewTitle.style.marginBottom = "40px";
                    negativeReviewTitle.style.fontSize = "25px";
                    negativeReviewTitle.style.color = "#333"; // ê¸€ì ìƒ‰ìƒ ì„¤ì •
                    reportContainer.appendChild(negativeReviewTitle);

                    imagePaths.forEach((path, index) => {
                        const img = document.createElement('img');
                        img.src = getFirebaseImageUrl("final-project-8f802.firebasestorage.app", path);
                        img.alt = "ë¶„ì„ ì´ë¯¸ì§€";
                        img.style.width = "50%";
                        img.style.marginBottom = "15px";
                        img.onerror = function () {
                            this.src = "https://via.placeholder.com/150";
                        };
                        reportContainer.appendChild(img);

                        // êµ¬ë¶„ì„  ì¶”ê°€
                        if (index < imagePaths.length - 1) { // ë§ˆì§€ë§‰ ì´ë¯¸ì§€ëŠ” ì œì™¸
                            const divider = document.createElement('hr');
                            divider.style.width = "90%";
                            divider.style.border = "0.5px solid #ccc";
                            divider.style.margin = "20px 0";
                            reportContainer.appendChild(divider);
                        }


                        // ë¶€ì • ë¦¬ë·° í‚¤ì›Œë“œ ì´ë¯¸ì§€ë¥¼ ì¶”ê°€í•˜ëŠ” ì¡°ê±´
                        if (index === 3) { // 'ë¶€ì • ë¦¬ë·° ë¹„ìœ¨' ì°¨íŠ¸ ì•„ë˜ ì¶”ê°€
                            const negativeReviewTitle = document.createElement('h3');
                            negativeReviewTitle.textContent = "ë¶€ì • ë¦¬ë·° í‚¤ì›Œë“œ";
                            negativeReviewTitle.style.marginTop = "30px";
                            negativeReviewTitle.style.fontSize = "20px";
                            negativeReviewTitle.style.color = "#333";
                            reportContainer.appendChild(negativeReviewTitle);
                        }
                    });

                    analysisReportContent.innerHTML = "";
                    analysisReportContent.appendChild(reportContainer);
                })
                .catch(error => {
                    document.getElementById('reviews-container').innerHTML = `<p>ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}</p>`;
                });

            // íƒ­ ì „í™˜ ì´ë²¤íŠ¸
            document.getElementById('all-reviews-tab').addEventListener('click', function () {
                document.getElementById('all-reviews-content').classList.add('active');
                document.getElementById('analysis-report-content').classList.remove('active');
                this.classList.add('active');
                document.getElementById('analysis-report-tab').classList.remove('active');
            });

            document.getElementById('analysis-report-tab').addEventListener('click', function () {
                document.getElementById('analysis-report-content').classList.add('active');
                document.getElementById('all-reviews-content').classList.remove('active');
                this.classList.add('active');
                document.getElementById('all-reviews-tab').classList.remove('active');
            });
        });

    </script>
</body>
</html>
